var Authorize_Url,EventProxy,Inte,User,config,crypto,fs,helper,https,path,plugs,regs,tointe,url;fs=require("fs"),path=require("path"),crypto=require("crypto"),EventProxy=require("eventproxy"),config=require("../config").config,https=require("https"),url=require("url"),plugs=require("./wechat-plugs"),helper=require("../lib/helper"),User=require("../model/mongo").User,Inte=require("../model/mongo").Inte,Authorize_Url="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+config.APPID+"&redirect_uri={url}&response_type=code&scope=snsapi_userinfo&state={state}#wechat_redirect",regs=function(e,n,r){var o;return console.log("regs"),o=new EventProxy.create("token","info",function(e,o){return console.log("返回的用户信息:",e,o),n.cookie("regs",null),null!=o&&null!=o.errcode?n.send({error:"授权失败."}):(n.locals.openid=e.openid,User.getUserOpenId(e.openid,function(n,t){return null!=t?r():User.newAndSave(e.openid,o.nickname,o.sex,o.province,o.country,o.headimgurl,function(e,n){return r()})}))}),null!=e.cookies.regs&&"now"===e.cookies.regs?null!=e.query.code?plugs.getUToken(e.query.code,function(e){return e.on("data",function(e){var n;return n=JSON.parse(e),o.emit("token",n),plugs.getAuUserInfo(n.access_token,n.openid,function(e){return e.on("data",function(e){var n;return n=JSON.parse(e),o.emit("info",n)})})})}):(o.emit("token",null),o.emit("info",null)):r()},exports.regs=regs,exports.before=function(e,n,r){var o;return n.locals.menu_my="",n.locals.menu_lucky="",n.locals.menu_exchange="",null!=e.cookies.openid&&"undefined"!==e.cookies.openid?(n.locals.openid=e.cookies.openid,r()):null!=e.cookies.regs&&"now"===e.cookies.regs?regs(e,n,r):(o=new EventProxy.create("token","user",function(o,t){var u,i,s;return console.log(o,o.openid),null==o.openid?n.send({error:"授权失败"}):(n.cookie("openid",o.openid),n.locals.openid=o.openid,null!=t?r():(url=e.originalUrl,s=e.query.state,url=url.split("?")[0],i=Authorize_Url,u=encodeURIComponent(config.host+url),s=i.replace("{state}",s),n.cookie("regs","now"),n.render("authorize",{url:i,href:u,state:s})))}),null!=e.query.code?plugs.getUToken(e.query.code,function(e){return e.on("data",function(e){var n;return n=JSON.parse(e),o.emit("token",n),null!=n.openid?User.getUserOpenId(n.openid,function(e,n){return o.emit("user",n)}):o.emit("user",null)})}):n.send({error:"授权失败."}))},exports.up=function(e,n,r){},exports["in"]=function(e,n,r){return console.log(e.cookies.openid),plugs.sendMenus(),tointe(e,n,r)},tointe=function(e,n,r){var o;return o=new helper.recode,Inte.today(n.locals.openid,function(e,r){return null!=r&&r.length<=0?Inte.newInte(n.locals.openid,20,"签到",function(e,r){return console.log("签到成功:",r),n.send(o)}):(o.recode=201,o.reason="今天已经签到过了.",n.send(o))})},exports.tointe=tointe,exports.my=function(e,n,r){var o;return n.locals.menu_my="active",console.log("openid:",n.locals.openid),o=new EventProxy.create("user","inte","today",function(e,r,o){var t,u,i,s;for(u=0,i=0,s=r.length;s>i;i++)t=r[i],t._id.openid+""==n.locals.openid+""&&(u=t.total);return n.render("my",{user:e,inte:u,today:o})}),Inte.today(e.cookies.openid,function(e,n){return o.emit("today",n)}),User.getUserOpenId(e.cookies.openid,function(e,n){return o.emit("user",n)}),Inte.getInteAll(e.cookies.openid,function(e,n){return o.emit("inte",n)})},exports.exchange=function(e,n,r){return n.locals.menu_exchange="active",n.render("exchange")},exports.exchange_type=function(e,n,r){return n.locals.menu_exchange="active",console.log(e.query.type_id),n.render("exchange-type")},exports.lucky=function(e,n,r){},exports.page1=function(e,n,r){return n.render("page1")},exports.page2=function(e,n,r){return n.render("page2")},exports.page3=function(e,n,r){return n.render("page3")},exports.page4=function(e,n,r){return n.render("page4")},exports.page5=function(e,n,r){return n.render("page5")},exports.page6=function(e,n,r){return n.render("page6")},exports.page7=function(e,n,r){return n.render("page7")};