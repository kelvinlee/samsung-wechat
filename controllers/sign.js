var Authorize_Url,EventProxy,Inte,User,config,crypto,fs,helper,https,path,plugs,regs,tointe,url;fs=require("fs"),path=require("path"),crypto=require("crypto"),EventProxy=require("eventproxy"),config=require("../config").config,https=require("https"),url=require("url"),plugs=require("./wechat-plugs"),helper=require("../lib/helper"),User=require("../model/mongo").User,Inte=require("../model/mongo").Inte,Authorize_Url="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+config.APPID+"&redirect_uri={url}&response_type=code&scope=snsapi_userinfo&state={state}#wechat_redirect",regs=function(e,n,o){var r;return console.log("regs"),r=new EventProxy.create("token","info",function(e,r){return console.log("返回的用户信息:",e,r),n.cookie("regs",null),null!=r&&null!=r.errcode?n.send({error:"授权失败."}):(n.locals.openid=e.openid,User.getUserOpenId(e.openid,function(n,t){return null!=t?o():User.newAndSave(e.openid,r.nickname,r.sex,r.province,r.country,r.headimgurl,function(e,n){return o()})}))}),null!=e.cookies.regs&&"now"===e.cookies.regs?null!=e.query.code?plugs.getUToken(e.query.code,function(e){return e.on("data",function(e){var n;return n=JSON.parse(e),r.emit("token",n),plugs.getAuUserInfo(n.access_token,n.openid,function(e){return e.on("data",function(e){var n;return n=JSON.parse(e),r.emit("info",n)})})})}):(r.emit("token",null),r.emit("info",null)):o()},exports.regs=regs,exports.before=function(e,n,o){var r;return n.locals.menu_my="",n.locals.menu_lucky="",n.locals.menu_exchange="",null!=e.cookies.openid&&"undefined"!==e.cookies.openid?(n.locals.openid=e.cookies.openid,o()):null!=e.cookies.regs&&"now"===e.cookies.regs?regs(e,n,o):(r=new EventProxy.create("token","user",function(r,t){var i,u,l;return console.log(r,r.openid),null==r.openid?n.send({error:"授权失败"}):(n.cookie("openid",r.openid),n.locals.openid=r.openid,null!=t?o():(url=e.originalUrl,l=e.query.state,url=url.split("?")[0],u=Authorize_Url,i=encodeURIComponent(config.host+url),l=u.replace("{state}",l),n.cookie("regs","now"),n.render("authorize",{url:u,href:i,state:l})))}),null!=e.query.code?plugs.getUToken(e.query.code,function(e){return e.on("data",function(e){var n;return n=JSON.parse(e),r.emit("token",n),null!=n.openid?User.getUserOpenId(n.openid,function(e,n){return r.emit("user",n)}):r.emit("user",null)})}):n.send({error:"授权失败."}))},exports.up=function(e,n,o){},exports["in"]=function(e,n,o){return console.log(e.cookies.openid),plugs.sendMenus(),tointe(e,n,o)},tointe=function(e,n,o){var r;return r=new helper.recode,Inte.today(n.locals.openid,function(e,o){return null!=o&&o.length<=0?Inte.newInte(n.locals.openid,20,"签到",function(e,o){return console.log("签到成功:",o),n.send(r)}):(r.recode=201,r.reason="今天已经签到过了.",n.send(r))})},exports.tointe=tointe,exports.my=function(e,n,o){var r;return n.locals.menu_my="active",console.log("openid:",n.locals.openid),r=new EventProxy.create("user","inte","today",function(e,o,r){var t,i,u,l;for(i=0,u=0,l=o.length;l>u;u++)t=o[u],t._id.openid+""==n.locals.openid+""&&(i=t.total);return n.render("my",{user:e,inte:i,today:r})}),Inte.today(e.cookies.openid,function(e,n){return r.emit("today",n)}),User.getUserOpenId(e.cookies.openid,function(e,n){return r.emit("user",n)}),Inte.getInteAll(e.cookies.openid,function(e,n){return r.emit("inte",n)})},exports.exchange=function(e,n,o){return n.locals.menu_exchange="active",n.render("exchange")},exports.exchange_type=function(e,n,o){return n.locals.menu_exchange="active",console.log(e.query.type_id),n.render("exchange-type")},exports.lucky=function(e,n,o){};