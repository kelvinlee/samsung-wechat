var BufferHelper,EventProxy,checkMessage,checkSignature,config,crypto,empty,formatMessage,fs,getMessage,jianxingpin,magazine,newactive,oversite,path,plugs,plugs_menu,plugs_subscribe,welcometext,xml2js;fs=require("fs"),path=require("path"),crypto=require("crypto"),xml2js=require("xml2js"),BufferHelper=require("bufferhelper"),EventProxy=require("eventproxy"),config=require("../config").config,plugs=require("./wechat-plugs"),checkSignature=function(e,t){var n,r,i,o,c;return o=null!=e.signature?e.signature:"",c=null!=e.timestamp?e.timestamp:"",r=null!=e.nonce?e.nonce:"",i=crypto.createHash("sha1"),n=[t,c,r].sort(),i.update(n.join("")),i.digest("hex")===o},getMessage=function(e,t){var n;return n=new BufferHelper,n.load(e,function(e,n){var r;return e?t(e):(r=n.toString("utf-8"),xml2js.parseString(r,{trim:!0},t))})},formatMessage=function(e){var t,n,r;if(n={},!e)return!1;for(t in e.xml)r=e.xml[t][0],n[t]=(null==r?"":r).trim();return n},checkMessage=function(e,t){var n;switch(n=null,e.MsgType){case"text":return console.log("文字信息"),t(n);case"image":return console.log("图片信息"),t(n);case"voice":return console.log("声音信息"),t(n);case"video":return console.log("视频信息"),t(n);case"location":return console.log("地理信息"),t(n);case"link":return console.log("链接消息"),t(n);case"event":return console.log("事件消息"),console.log(e.Event),"subscribe"===e.Event?plugs_subscribe(e,t):"CLICK"===e.Event||"VIEW"===e.Event?plugs_menu(e,t):t(n)}return t(n)},exports.sendmenu=function(e,t,n){return plugs.sendMenus(),t.send("ok")},exports.index=function(e,t,n){var r,i,o;return i=e.query,o=checkSignature(i,config.wechat_token),r=new EventProxy.create("message","backMsg",function(e,n){if(console.log("run backMsg"),null==n)return t.render("wechat/wechat-text",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),content:""});switch(n.type){case"text":return null!=n.random&&(n.content=n.random[Math.round(Math.random()*(n.random.length-1))]),t.render("wechat/wechat-text",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),content:n.content});case"news":return t.render("wechat/wechat-news",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),items:n.items});default:return t.render("wechat/wechat-text",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),content:""})}}),getMessage(e,function(e,n){var c;return e&&console.log(e),n?(c=formatMessage(n),r.emit("message",c),checkMessage(c,function(e){return console.log("back To: ",e),r.emit("backMsg",e)})):t.send(o?i.echostr:"what?")})},welcometext={name:"welcome",key:"你好",type:"text",backContent:"欢迎关注【三星乐园】，【看名车志，赢车模】活动于5月22日18时已结束，感谢大家的支持与参与。更多精彩内容，敬请期待。"},plugs_subscribe=function(e,t){return t(welcometext)},newactive={name:"新活动",key:"1",type:"news",items:[{backContent:"关注三星乐园微信公众账号",title:"关注三星乐园微信公众账号,惊喜大礼等你拿!",description:"关注三星乐园微信公众账号,惊喜大礼等你拿!",picurl:"http://115.28.106.34/img/banner-1.jpg",url:"http://115.28.106.34/art/1"},{backContent:"GALAXY K zoom让每个瞬间都精彩",title:"GALAXY K zoom让每个瞬间都精彩!",description:"GALAXY K zoom让每个瞬间都精彩!",picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzPrkjqVuXnZk7kv2dM1ed7uuJ11IicjPwfuicc6tmAVhrLyolJTe2oThaatNbInYZBdmBAlJMWfrZqw/0",url:"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200501036&idx=1&sn=7c19d06ff08719359639336eb357bbfe#rd"},{backContent:"关注三星乐园微信公众账号",title:"“装女郎梦想秀”全国网络15强海选活动开始啦!",description:"“装女郎梦想秀”全国网络15强海选活动开始啦!",picurl:"http://115.28.106.34/img/banner-2.jpg",url:"http://115.28.106.34/art/2"}]},oversite={name:"查看活动详情",key:"1",type:"news",items:[{backContent:"活动详情",title:"临·现场",description:"临·现场",picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO6ZUIrhM8bc1FQxoQAIggvhSkRKbz4gVROjv5MeibQOaRvAKMXFxa6oBicAoMYVRKOekMicUEEyOIww/0",url:"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200198976&idx=1&sn=f0508d0792f15fc2c812fe77a04192b6#rd"}]},jianxingpin={name:"查看活动详情",key:"1",type:"news",items:[{backContent:"活动详情",title:"鉴·星品",description:"鉴·星品",picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO6ZUIrhM8bc1FQxoQAIggvhSkRKbz4gVROjv5MeibQOaRvAKMXFxa6oBicAoMYVRKOekMicUEEyOIww/0",url:"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200198976&idx=1&sn=f0508d0792f15fc2c812fe77a04192b6#rd"}]},magazine={name:"查看活动详情",key:"1",type:"news",items:[{backContent:"活动详情",title:"看·杂志",description:"看·杂志",picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO6ZUIrhM8bc1FQxoQAIggvhSkRKbz4gVROjv5MeibQOaRvAKMXFxa6oBicAoMYVRKOekMicUEEyOIww/0",url:"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200198976&idx=1&sn=f0508d0792f15fc2c812fe77a04192b6#rd"}]},empty={name:"返回收到图片信息.",key:"1",type:"text",backContent:""},plugs_menu=function(e,t){return console.log(e),t("oversite"===e.EventKey?oversite:"jianxingpin"===e.EventKey?jianxingpin:"magazine"===e.EventKey?magazine:"newactive"===e.EventKey?newactive:empty)};