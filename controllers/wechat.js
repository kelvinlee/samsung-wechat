var BufferHelper,EventProxy,checkMessage,checkSignature,config,crypto,formatMessage,fs,getMessage,path,plugs,plugs_menu,plugs_subscribe,welcometext,xml2js;fs=require("fs"),path=require("path"),crypto=require("crypto"),xml2js=require("xml2js"),BufferHelper=require("bufferhelper"),EventProxy=require("eventproxy"),config=require("../config").config,plugs=require("./wechat-plugs"),checkSignature=function(e,t){var r,n,s,o,c;return o=null!=e.signature?e.signature:"",c=null!=e.timestamp?e.timestamp:"",n=null!=e.nonce?e.nonce:"",s=crypto.createHash("sha1"),r=[t,c,n].sort(),s.update(r.join("")),s.digest("hex")===o},getMessage=function(e,t){var r;return r=new BufferHelper,r.load(e,function(e,r){var n;return e?t(e):(n=r.toString("utf-8"),xml2js.parseString(n,{trim:!0},t))})},formatMessage=function(e){var t,r,n;if(r={},!e)return!1;for(t in e.xml)n=e.xml[t][0],r[t]=(null==n?"":n).trim();return r},checkMessage=function(e,t){var r;switch(r=null,e.MsgType){case"text":return console.log("文字信息"),t(r);case"image":return console.log("图片信息"),t(r);case"voice":return console.log("声音信息"),t(r);case"video":return console.log("视频信息"),t(r);case"location":return console.log("地理信息"),t(r);case"link":return console.log("链接消息"),t(r);case"event":return console.log("事件消息"),"subscribe"===e.Event?plugs_subscribe(e,t):"click"===e.Event||"view"===e.Event?plugs_menu(e,t):t(r)}return t(r)},exports.sendmenu=function(e,t,r){return plugs.sendMenus(),t.send("ok")},exports.index=function(e,t,r){var n,s,o;return s=e.query,o=checkSignature(s,config.wechat_token),n=new EventProxy.create("message","backMsg",function(e,r){if(null==r)return t.render("wechat/wechat-text",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),content:""});switch(r.type){case"text":return null!=r.random&&(r.content=r.random[Math.round(Math.random()*(r.random.length-1))]),t.render("wechat/wechat-text",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),content:r.content});case"news":return t.render("wechat-news",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),title:r.title,description:r.description,picurl:r.picurl,url:r.url});default:return t.render("wechat/wechat-text",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),content:""})}}),getMessage(e,function(e,r){var c;return e&&console.log(e),r?(c=formatMessage(r),n.emit("message",c),checkMessage(c,function(e){return console.log("back To: ",e),n.emit("backMsg",e)})):t.send(o?s.echostr:"what?")})},welcometext={name:"welcome",key:"你好",type:"text",backContent:"欢迎关注【三星乐园】，【看名车志，赢车模】活动于5月22日18时已结束，感谢大家的支持与参与。更多精彩内容，敬请期待。"},plugs_subscribe=function(e,t){return t(welcometext)},plugs_menu=function(e,t){return"newsactive"===e.key&&t(welcometext),t(welcometext)};