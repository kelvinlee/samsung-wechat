var BufferHelper,EventProxy,checkMessage,checkSignature,config,crypto,empty,formatMessage,fs,getMessage,jianxingpin,magazine,newactive,oversite,path,plugs,plugs_menu,plugs_subscribe,welcometext,xml2js;fs=require("fs"),path=require("path"),crypto=require("crypto"),xml2js=require("xml2js"),BufferHelper=require("bufferhelper"),EventProxy=require("eventproxy"),config=require("../config").config,plugs=require("./wechat-plugs"),checkSignature=function(e,t){var n,r,i,o,c;return o=null!=e.signature?e.signature:"",c=null!=e.timestamp?e.timestamp:"",r=null!=e.nonce?e.nonce:"",i=crypto.createHash("sha1"),n=[t,c,r].sort(),i.update(n.join("")),i.digest("hex")===o},getMessage=function(e,t){var n;return n=new BufferHelper,n.load(e,function(e,n){var r;return e?t(e):(r=n.toString("utf-8"),xml2js.parseString(r,{trim:!0},t))})},formatMessage=function(e){var t,n,r;if(n={},!e)return!1;for(t in e.xml)r=e.xml[t][0],n[t]=(null==r?"":r).trim();return n},checkMessage=function(e,t){var n;switch(n=null,e.MsgType){case"text":return console.log("文字信息"),t(n);case"image":return console.log("图片信息"),t(n);case"voice":return console.log("声音信息"),t(n);case"video":return console.log("视频信息"),t(n);case"location":return console.log("地理信息"),t(n);case"link":return console.log("链接消息"),t(n);case"event":return console.log("事件消息"),console.log(e.Event),"subscribe"===e.Event?plugs_subscribe(e,t):"click"===e.Event||"view"===e.Event?plugs_menu(e,t):t(n)}return t(n)},exports.sendmenu=function(e,t,n){return plugs.sendMenus(),t.send("ok")},exports.index=function(e,t,n){var r,i,o;return i=e.query,o=checkSignature(i,config.wechat_token),r=new EventProxy.create("message","backMsg",function(e,n){if(null==n)return t.render("wechat/wechat-text",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),content:""});switch(n.type){case"text":return null!=n.random&&(n.content=n.random[Math.round(Math.random()*(n.random.length-1))]),t.render("wechat/wechat-text",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),content:n.content});case"news":return t.render("wechat-news",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),title:n.title,description:n.description,picurl:n.picurl,url:n.url});default:return t.render("wechat/wechat-text",{toUser:e.FromUserName,fromUser:e.ToUserName,date:(new Date).getTime(),content:""})}}),getMessage(e,function(e,n){var c;return e&&console.log(e),n?(c=formatMessage(n),r.emit("message",c),checkMessage(c,function(e){return console.log("back To: ",e),r.emit("backMsg",e)})):t.send(o?i.echostr:"what?")})},welcometext={name:"welcome",key:"你好",type:"text",backContent:"欢迎关注【三星乐园】，【看名车志，赢车模】活动于5月22日18时已结束，感谢大家的支持与参与。更多精彩内容，敬请期待。"},plugs_subscribe=function(e,t){return t(welcometext)},newactive={name:"查看活动详情",key:"1",type:"news",backContent:"活动详情",title:"临·现场",description:"临·现场",picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO6ZUIrhM8bc1FQxoQAIggvhSkRKbz4gVROjv5MeibQOaRvAKMXFxa6oBicAoMYVRKOekMicUEEyOIww/0",url:"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200198976&idx=1&sn=f0508d0792f15fc2c812fe77a04192b6#rd"},oversite={name:"查看活动详情",key:"1",type:"news",backContent:"活动详情",title:"临·现场",description:"临·现场",picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO6ZUIrhM8bc1FQxoQAIggvhSkRKbz4gVROjv5MeibQOaRvAKMXFxa6oBicAoMYVRKOekMicUEEyOIww/0",url:"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200198976&idx=1&sn=f0508d0792f15fc2c812fe77a04192b6#rd"},jianxingpin={name:"查看活动详情",key:"1",type:"news",backContent:"活动详情",title:"鉴·星品",description:"鉴·星品",picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO6ZUIrhM8bc1FQxoQAIggvhSkRKbz4gVROjv5MeibQOaRvAKMXFxa6oBicAoMYVRKOekMicUEEyOIww/0",url:"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200198976&idx=1&sn=f0508d0792f15fc2c812fe77a04192b6#rd"},magazine={name:"查看活动详情",key:"1",type:"news",backContent:"活动详情",title:"看·杂志",description:"看·杂志",picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO6ZUIrhM8bc1FQxoQAIggvhSkRKbz4gVROjv5MeibQOaRvAKMXFxa6oBicAoMYVRKOekMicUEEyOIww/0",url:"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200198976&idx=1&sn=f0508d0792f15fc2c812fe77a04192b6#rd"},empty={name:"返回收到图片信息.",key:"1",type:"text",backContent:""},plugs_menu=function(e,t){return console.log(e),t("oversite"===e.key?oversite:"jianxingpin"===e.key?jianxingpin:"magazine"===e.key?magazine:"newactive"===e.key?newactive:empty)};