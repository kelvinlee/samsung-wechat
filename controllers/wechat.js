// Generated by CoffeeScript 1.7.1

/*
--------------------------------------------
     Begin wechat.coffee
--------------------------------------------
 */
var BufferHelper, Comment, EventProxy, Inte, Lots, Topic, User, Warehouse, checkMessage, checkSignature, clearQA, config, crypto, empty,luckyOver, formatMessage, fs, gamemenu, getMessage, getQA, jianxingpin, luckymenu, magazine, my, myProcess, newactive, overQA, oversite, path, plugs, plugs_menu, plugs_subscribe, regsinto, searchQA, topicmenu, videos, huishenghuo, welcometext, xml2js, _nr, _qa;

fs = require('fs');

path = require('path');

crypto = require('crypto');

xml2js = require('xml2js');

BufferHelper = require('bufferhelper');

EventProxy = require('eventproxy');

config = require('../config').config;

plugs = require('./wechat-plugs');

User = require('../model/mongo').User;

Inte = require('../model/mongo').Inte;

Lots = require('../model/mongo').Lots;

Warehouse = require('../model/mongo').Warehouse;

Topic = require('../model/mongo').Topic;

Comment = require('../model/mongo').Comment;

var middle = "/mid";

checkSignature = function(query, token) {
  var arr, nonce, shasum, signature, timestamp;
  signature = query.signature != null ? query.signature : '';
  timestamp = query.timestamp != null ? query.timestamp : '';
  nonce = query.nonce != null ? query.nonce : '';
  shasum = crypto.createHash('sha1');
  arr = [token, timestamp, nonce].sort();
  shasum.update(arr.join(''));
  return shasum.digest('hex') === signature;
};

getMessage = function(stream, callback) {
  var buf;
  buf = new BufferHelper();
  return buf.load(stream, function(err, buf) {
    var xml;
    if (err) {
      return callback(err);
    }
    xml = buf.toString('utf-8');
    return xml2js.parseString(xml, {
      trim: true
    }, callback);
  });
};

formatMessage = function(result) {
  var key, message, val;
  message = {};
  if (!result) {
    return false;
  }
  for (key in result.xml) {
    val = result.xml[key][0];
    message[key] = (val == null ? '' : val).trim();
  }
  return message;
};

checkMessage = function(message, callback) {
  var re;
  re = null;
  switch (message.MsgType) {
    case 'text':
      console.log('文字信息');
      return getQA(message.Content, message.FromUserName, callback);
    case 'image':
      console.log('图片信息');
      return callback(re);
    case 'voice':
      console.log('声音信息');
      return callback(re);
    case 'video':
      console.log('视频信息');
      return callback(re);
    case 'location':
      console.log('地理信息');
      return callback(re);
    case 'link':
      console.log('链接消息');
      return callback(re);
    case 'event':
      console.log('事件消息');
      console.log(message.Event);
      if (message.Event === 'subscribe') {
        return plugs_subscribe(message, callback);
      }
      if (message.Event === 'CLICK' || message.Event === 'VIEW') {
        return plugs_menu(message, callback);
      }
      return callback(re);
  }
  return callback(re);
};

exports.sendmenu = function(req, res, next) {
  plugs.sendMenus();
  return res.send("ok");
};

exports.index = function(req, res, next) {
  var ep, parse, to;
  parse = req.query;
  to = checkSignature(parse, config.wechat_token);
  ep = new EventProxy.create("message", "backMsg", function(message, backMsg) {
    console.log("run backMsg");
    if (backMsg != null) {
      switch (backMsg.type) {
        case 'text':
          if (backMsg.random != null) {
            backMsg.content = backMsg.random[Math.round(Math.random() * (backMsg.random.length - 1))];
          }
          return res.render('wechat/wechat-text', {
            toUser: message.FromUserName,
            fromUser: message.ToUserName,
            date: new Date().getTime(),
            content: backMsg.content
          });
        case 'news':
          return res.render('wechat/wechat-news', {
            toUser: message.FromUserName,
            fromUser: message.ToUserName,
            date: new Date().getTime(),
            items: backMsg.items
          });
        default:
          return res.render('wechat/wechat-text', {
            toUser: message.FromUserName,
            fromUser: message.ToUserName,
            date: new Date().getTime(),
            content: ""
          });
      }
    } else {
      return res.render('wechat/wechat-text', {
        toUser: message.FromUserName,
        fromUser: message.ToUserName,
        date: new Date().getTime(),
        content: ""
      });
    }
  });
  return getMessage(req, function(err, result) {
    var message;
    if (err) {
      console.log(err);
    }
    if (!result) {
      return res.send(to ? parse.echostr : "v1.0.1");
    }
    message = formatMessage(result);
    ep.emit('message', message);
    return checkMessage(message, function(back) {
      console.log("back To: ", back);
      return ep.emit('backMsg', back);
    });
  });
};


/*
--------------------------------------------
     Begin wechat-subscribe.coffee
--------------------------------------------
 */
/*
welcometext = function() {
  return {
    name: "新活动",
    key: "1",
    type: "news",
    items: [
      {
        title: "乐园嘉年华，关注赢好礼，GALAXY Tab S 等你来拿。",
        description: '乐园嘉年华，关注赢好礼，GALAXY Tab S 等你来拿。',
        picurl: "" + config.host + "/img/banner-1.jpg",
        url: "" + config.host + middle +"/{openid}?url=/page1"
      }, {
        title: "Samsung GALAXY Tab S 炫丽屏重新定义「视」界",
        description: 'Samsung GALAXY Tab S 炫丽屏重新定义「视」界',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO0MI2JicM7fHVaiaQeTniaYBH9RQ1iaJH9XK6iatFxjdE8WQ8qFqEZ2MOz89T8ZcBBLJP9gIzH9pTbpeQ/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200559196&idx=1&sn=65df46c2bf8f852d815d3bb887c96ee2#rd"
      }, {
        title: "星炫刊 ︳我们与 Samsung GALAXY Tab S 的色彩故事",
        description: '星炫刊 ︳我们与 Samsung GALAXY Tab S 的色彩故事',
        picurl: config.host + "/img/icon-1.jpg",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=201614397&idx=1&sn=ae32c9b9fd34996932f72d4ee173b69c#rd"
      }, {
        title: "搜狐视频独播《巡夜人日志》第一集创韩国月火剧收视冠军！",
        description: '搜狐视频独播《巡夜人日志》第一集创韩国月火剧收视冠军！',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzPCniaCMicnMqqz1SFKI2coiaGOK1oLv8AmxicppGDsiatrJ1dP2t7VECcfwotwNthMUzysywXVckjmfrg/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=201179385&idx=1&sn=1e5ec46885ceabc0531703b442f0cce7#rd"
      }
    ]
  };
};
*/


welcometext = function() {
  return {
    name: "欢迎语",
  	key: "1",
 	type: "text",
 	content: "欢迎关注三星乐园"
  };
};


plugs_subscribe = function(message, callback) {
  var subscribe;
  subscribe = new welcometext();
  // subscribe.items[0].url = subscribe.items[0].url.replace("{openid}", message.FromUserName);
  return callback(subscribe);
};


/*
--------------------------------------------
     Begin wechat-menu.coffee
--------------------------------------------
 */

newactive = function() {
  return {
    name: "新·活动",
    key: "1",
    type: "news",
    items: [
      {
        title: "看潮流【三星杂志】，抢最强YG FAMILY演唱会门票~",
        description: '看潮流【三星杂志】，抢最强YG FAMILY演唱会门票~',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzOHNXYdJk1maibPtzdfQ73a8QsNicvEwsDBJib5fapuLYE2QdKrD6Mib8AyzlzniaoWkrz7ZeRHfGtqNcQ/0",// + config.host + "/img/banner-1.jpg",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=206330598&idx=1&sn=4cc7633861162a450d4feea6584c6eb7#rd"// + config.host + middle +"/{openid}?url=/page1"
      }, {
        title: "用【三星钱包】抢限量福利门票，看四小时狂欢音乐狂潮！还等什么快来抢票！",
        description: '用【三星钱包】抢限量福利门票，看四小时狂欢音乐狂潮！还等什么快来抢票！',
        picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzOHNXYdJk1maibPtzdfQ73a8d1bz3gx1l2rHnheG2SuqO6xejYmJic69clkfa3dqRCj2B6C4zJWHfzQ/0",// "" + config.host + "/img/weixin-topic.jpg",
        url:"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=206330598&idx=3&sn=3b022cbe15c7b3b066f81f5ac05d217c#rd"// "" + config.host + middle +"/{openid}?url=/sign/topic"
      }
    ]
  };
};



oversite = function() {
  return {
    name: "临·现场",
    key: "1",
    type: "news",
    items: [
      {
        title: "重新定义“视”界 三星 GALAXY Tab S 开启色彩大门",
        description: '【2014 年 7 月 7 日，上海】三星电子于上海世博创意秀场正式推出旗下迄今最轻薄的平板电脑 GALAXY Tab S，为中国消费者揭开了这款万众期待的平板电脑的神秘面纱。',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO0MI2JicM7fHVaiaQeTniaYBHfExcwyqI7M2wbuPcJwiaKmWASIhFeNMc9jLy5p0xevNicFme4oeic1lZg/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200559799&idx=1&sn=9f9276bef86f5fa505897df138559a31#rd"
      }
    ]
  };
};

jianxingpin = function() {
  return {
    name: "鉴·星品",
    key: "1",
    type: "news",
    items: [
      {
        title:"用心表达，感动生活",// "Samsung GALAXY Tab S 炫丽屏重新定义「视」界",
        description: '用心表达，感动生活',
        picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzOHNXYdJk1maibPtzdfQ73a8nicMnl6iaOUNG5hRavUS5ib9nAAERwFoKEBRVHuhnm8yNhbWyUpmYrQlw/0",// "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO0MI2JicM7fHVaiaQeTniaYBH9RQ1iaJH9XK6iatFxjdE8WQ8qFqEZ2MOz89T8ZcBBLJP9gIzH9pTbpeQ/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=205586303&idx=1&sn=43a8e62c8ad5680309ff7d63dff71cc7#rd"//"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200559196&idx=1&sn=65df46c2bf8f852d815d3bb887c96ee2#rd"
      }, {
        title: "Note4超值应用大礼，三星礼包给你尊贵礼遇！",//"Samsung GALAXY Tab S Super AMOLED 介绍",
        description: 'Note4超值应用大礼，三星礼包给你尊贵礼遇！',//'Super AMOLED 介绍',
        picurl:"https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzOHNXYdJk1maibPtzdfQ73a8SWib6gWDX5ORlD9Pymu6RJosTSM429mHBWOiaVjv70xHIhsSa8V42uHQ/0",// "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO0MI2JicM7fHVaiaQeTniaYBHRQObuicHPsbAsdZxcVuoqNiatI3jCoVOmiaqtYGV0ObgL4KESxVmnk6Qw/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=206330598&idx=2&sn=0055dc5f96d6d258f7accf4bd635367e#rd"//"http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200559196&idx=2&sn=e63c12ed63c62ade95295f7f04570a01#rd"
      }, {
        title: "Samsung GALAXY K zoom 让每个瞬间都精彩",
        description: 'Samsung GALAXY K zoom 让每个瞬间都精彩',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzO0MI2JicM7fHVaiaQeTniaYBH6fTuuEtLsy7fGvZsBflV9SOpY5iacHiaDd056ZA3aq8HGPxEzzpEq5aw/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200559196&idx=3&sn=a3cefce3da85b400072a9303de8be9e4#rd"
      }
    ]
  };
};

huishenghuo = function() {
  return {
    name: "绘·生活",
    key: "1",
    type: "news",
    items: [
      {
        title: "画你所想，写你所愿，S Pen-你的百变万能“喵”",
        description: '画你所想，写你所愿，S Pen-你的百变万能“喵”',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzP1TyW8z4q7t6ibibZVFKQFicMMKaqPml5WBaFIQ0x5uDic3cbr4hT2X2huDbx1YZsoyxT36YgYZ4fwicg/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=205066535&idx=1&sn=93628cb11f6fe5790852c60d6fde8306#rd"
      }, {
        title: "S Pen书写回忆，涂鸦童真",
        description: 'S Pen书写回忆，涂鸦童真',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzP1TyW8z4q7t6ibibZVFKQFicMPsuG3KIZPTpVtmL8FHPicTiaLkYJh0xF49ibr3312CJzibW17hAedsJAPg/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=205066535&idx=2&sn=fbca8f72a600e469a6908f8ea74920c8#rd"
      }, {
        title: "再忙也要甜蜜蜜，陪你去看流星雨",
        description: '再忙也要甜蜜蜜，陪你去看流星雨',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzP1TyW8z4q7t6ibibZVFKQFicMYV3WjPzZibkOF52h3xibyhSx4dGB3zNz19LxR2JQ48EL5qOpRO869BJg/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=205066535&idx=3&sn=65e5bb94d517337a5c8e9bd9c5f4aa73#rd"
      }, {
        title: "随心描绘百变美丽",
        description: '随心描绘百变美丽',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzP1TyW8z4q7t6ibibZVFKQFicMSeSQsZaaddmdttiaMY235wKry2epic8tjic7JicZmJ8Uia9qROVQXDFsdNg/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=205066535&idx=4&sn=aa75a5f9d8eadd02f91106c756cc36a2#rd"
      }, {
        title: "一起来“黑”家中萌宠",
        description: '一起来“黑”家中萌宠',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzP1TyW8z4q7t6ibibZVFKQFicMF79Iq6CgSzfMavfqsH6f6iaBgkKwcFDfxQmVe04QwvWa6A7NG5wKpvg/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=205066535&idx=5&sn=0ee2951577373dc9eba19844d68487f3#rd"
      }
    ]
  };
};
magazine = function() {
  return {
    name: "看杂志",
    key: "1",
    type: "news",
    items: [
      {
        title: "星炫刊 ︳Super AMOLED炫丽屏，定义「视」界新主张",
        description: '星炫刊 ︳Super AMOLED炫丽屏，定义「视」界新主张',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzM7uFF29KWYB3HePFqWtoicwicuEZJhh9GTibeBQibCugllg2uYSKzRzbJ1WOVEeibXDxQic3CicicOEEXdXw/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=201614397&idx=1&sn=ae32c9b9fd34996932f72d4ee173b69c#rd"
      }, {
        title: "时尚健康 | 时尚生活，健康领跑",
        description: '时尚健康 | 时尚生活，健康领跑',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzMFOibMfChYQiclHwBaGW7kfelthH4cVBruQJdPYXBHsvxia0uLhicE5ouT0o7A96yicZibPvby84gGpAPQ/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=205865171&idx=4&sn=f81e661685c4d360491b640b2fed2870#rd"
      }, {
        title: "时尚先生 | 时尚造就先生 先生定义时尚",
        description: '时尚先生 | 时尚造就先生 先生定义时尚',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzMBQiaRnw4BwANTl9cwE2GI8kHQnQ2fa0lmibW3ibHmibIl5c9sYicj6XORgDj13ibXK7ibSK7WUtc0NMibcQ/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=201614397&idx=3&sn=ae8a9084e3205f8cbc9fc0ad873f77f3#rd"
      }, {
        title: "新潮电子 | 最精彩的数字时尚生活",
        description: '新潮电子 | 最精彩的数字时尚生活',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzP1TyW8z4q7t6ibibZVFKQFicMwASEEz0Sw43BmeYhsibMc3LIjlh1lSCOI6MFK012l0YrKyf7licUwDTA/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=201614397&idx=4&sn=979f46d7f03d3affdc746e27780e44b3#rd"
      }
    ]
  };
};

my = function() {
  return {
    name: "查积分",
    key: "1",
    type: "news",
    items: [
      {
        title: "积分信息查询",
        description: '您的积分是:{jf}积分,点击《阅读全文》查看详细信息. [请勿转发此条信息,包含您的个人信息]',
        picurl: "" + config.host + "/img/banner-into.jpg",
        url: "" + config.host + middle +"/{openid}?url=/sign/my"
      }
    ]
  };
};

regsinto = function() {
  return {
    name: "来签到",
    key: "1",
    type: "news",
    items: [
      {
        title: "签到获取更多积分",
        description: '您的积分是:{jf}积分,点击《阅读全文》查看详细信息. [请勿转发此条信息,包含您的个人信息]',
        picurl: "" + config.host + "/img/banner-qd.jpg",
        url: "" + config.host + middle +"/{openid}?url=/page7"
      }
    ]
  };
};

topicmenu = function() {
  return {
    name: "聊话题",
    key: "1",
    type: "news",
    items: [
      {
        title: "参与每日话题，赢取精美礼品",
        description: '聊话题赢大奖. [请勿转发此条信息,包含您的个人信息]',
        picurl: "" + config.host + "/img/banner-topic.jpg",
        url: "" + config.host + middle +"/{openid}?url=/sign/topic"
      }
    ]
  };
};

luckymenu = function() {
  return {
	  
	  
    name: "试手气",
    key: "1",	
    type: "news",
    items: [
      {
        title: "来试试看你的手气,赢大奖",
        description: '摇转轮盘赢大奖. [请勿转发此条信息,包含您的个人信息]',
        picurl: "" + config.host + "/img/banner-lucky.jpg",
        url: "" + config.host + middle +"/{openid}?url=/sign/lucky"
      }
    ]
  };
};

gamemenu = function() {
  return {
    name: "玩游戏",
    key: "1",
    type: "news",
    items: [
      {
        title: "玩热门网游，领豪华礼包！",
        description: '点击玩·游戏，下载三星专版游戏，超级礼包等你来拿！',
        picurl: "" + config.host + "/img/banner-20.jpg",
        url: "" + config.host + middle +"/{openid}?url=/sign/exchange/1"
      }
    ]
  };
};

videos = function() {
  return {
    name: "观视频",
    key: "1",
    type: "news",
    items: [
      {
        title: "《亲爱的》揭神秘面纱 独家纪录赵薇秒变村妇心路历程",
        description: '《亲爱的》揭神秘面纱 独家纪录赵薇秒变村妇心路历程',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzMBQiaRnw4BwANTl9cwE2GI8x2GjcR49FoboCAOMrhdprycT4fwN5KQTkLwS4qOvZdMVWNtKM1Llnw/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=201179385&idx=1&sn=1e5ec46885ceabc0531703b442f0cce7#rd"
      }, {
        title: "《我爱三星视频秀》54期：GALAXY Tab S 绚丽世界中的精彩应用",
        description: '《我爱三星视频秀》54期：GALAXY Tab S 绚丽世界中的精彩应用',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzPCniaCMicnMqqz1SFKI2coiaGqziaptWvH56GQd7HSR6MENCo9XD8YX37qKIjQAf4CND7xaicicjBiam0xA/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=201179385&idx=2&sn=350a13b6b1aabb9a27a7911309a73111#rd"
      }, {
        title: "《Running Man》死忠粉眼中的《奔跑吧 兄弟》",
        description: '《Running Man》死忠粉眼中的《奔跑吧 兄弟》',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzMBQiaRnw4BwANTl9cwE2GI80AGsXicKYLUEZ3qLwyUxgZvUNdsM7HjwGY2scqUQDyu2jMXMFQrHtnA/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=201179385&idx=3&sn=ce36d8402e61e53e5267fe02997b2f13#rd"
      }, {
        title: "《花千骨》正式版15min超长片花首曝光 霍建华虐刺赵丽颖103剑",
        description: '《花千骨》正式版15min超长片花首曝光 霍建华虐刺赵丽颖103剑',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzMBQiaRnw4BwANTl9cwE2GI84WTZVToVicvTweAdEpcPia8A6ZnaFcQJNjCko73WHFfWI8EpHIWq5HDQ/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=201179385&idx=4&sn=2c0626281303dc2a457914ab10761355#rd"
      }
    ]
  };
};

empty = {
  name: "返回收到图片信息.",
  key: "1",
  type: "text",
  backContent: ""
};

luckyOver = {
  name: "活动已经结束.",
  key: "1",
  type: "text",
  backContent: ""
};

plugs_menu = function(message, callback) {
  var newmy;
  console.log(message);
  openid = message.FromUserName;
  User.getUserOpenId(openid, function(err, user) {
    console.log("openid:", openid, err, user);
    if (user != null) {
      // res.cookie("userid", user._id);
      // res.cookie("openid", openid);
      console.log({
        "老用户": true,
        user: user
      });
      // return res.redirect(url);
      plugs_event(message,callback);
    } else {
      return User.regbyOpenId(openid, function(err, user) {
        console.log(err, user);
        // res.cookie("userid", user._id);
        // res.cookie("openid", openid);
        return Inte.newInte(user._id, 100, "初次注册赠送积分活动,100积分", function(err, inte) {
          console.log({
            "老用户": false,
            user: user
          });
          // return res.redirect(url);
          plugs_event(message,callback);
        });
      });
    }
  });
};

plugs_event = function(message,callback) {
  if (message.EventKey === "oversite") {
    return callback(new oversite());
  } else if (message.EventKey === "jianxingpin") {
    return callback(new jianxingpin());
  } else if (message.EventKey === "huishenghuo") {
    return callback(new huishenghuo());
  } else if (message.EventKey === "magazine") {
    return callback(new magazine());
  } else if (message.EventKey === "newactive") {
    newmy = new newactive();
    newmy.items[0].url = newmy.items[0].url.replace("{openid}", message.FromUserName);
    newmy.items[1].url = newmy.items[1].url.replace("{openid}", message.FromUserName);
    return User.getUserOpenId(message.FromUserName, function(err, user) {
      if (user != null) {
        return Inte.getInteAll(user._id, function(err, count) {
          return callback(newmy);
        });
      } else {
        return callback(newmy);
      }
    });
  } else if (message.EventKey === "my") {
    newmy = new my();
    newmy.items[0].url = newmy.items[0].url.replace("{openid}", message.FromUserName);
    return User.getUserOpenId(message.FromUserName, function(err, user) {
      console.log(newmy.items[0].url);
      if (user != null) {
        return Inte.getInteAll(user._id, function(err, count) {
          newmy.items[0].description = newmy.items[0].description.replace("{jf}", count);
          return callback(newmy);
        });
      } else {
        newmy.items[0].description = newmy.items[0].description.replace("{jf}", "0");
        return callback(newmy);
      }
    });
  } else if (message.EventKey === "regsinto") {
    newmy = new regsinto();
    newmy.items[0].url = newmy.items[0].url.replace("{openid}", message.FromUserName);
    return User.getUserOpenId(message.FromUserName, function(err, user) {
      console.log(newmy.items[0].url);
      if (user != null) {
        return Inte.getInteAll(user._id, function(err, count) {
          newmy.items[0].description = newmy.items[0].description.replace("{jf}", count);
          return callback(newmy);
        });
      } else {
        newmy.items[0].description = newmy.items[0].description.replace("{jf}", "0");
        return callback(newmy);
      }
    });
  } else if (message.EventKey === "topic") {
    newmy = new topicmenu();
    newmy.items[0].url = newmy.items[0].url.replace("{openid}", message.FromUserName);
    return User.getUserOpenId(message.FromUserName, function(err, user) {
      console.log(newmy.items[0].url);
      if (user != null) {
        return Inte.getInteAll(user._id, function(err, count) {
          return callback(newmy);
        });
      } else {
        return callback(newmy);
      }
    });
  } else if (message.EventKey === "lucky") {
    return callback(luckyOver);
	
	newmy = new luckymenu();
    newmy.items[0].url = newmy.items[0].url.replace("{openid}", message.FromUserName);
    return User.getUserOpenId(message.FromUserName, function(err, user) {
      console.log(newmy.items[0].url);
      if (user != null) {
        return Inte.getInteAll(user._id, function(err, count) {
          return callback(newmy);
        });
      } else {
        return callback(newmy);
      }
    });
  } else if (message.EventKey === "game") {
    newmy = new gamemenu();
    newmy.items[0].url = newmy.items[0].url.replace("{openid}", message.FromUserName);
    return User.getUserOpenId(message.FromUserName, function(err, user) {
      console.log(newmy.items[0].url);
      if (user != null) {
        return Inte.getInteAll(user._id, function(err, count) {
          return callback(newmy);
        });
      } else {
        return callback(newmy);
      }
    });
  } else if (message.EventKey === "videos") {
    newmy = new videos();
    newmy.items[0].url = newmy.items[0].url.replace("{openid}", message.FromUserName);
    return User.getUserOpenId(message.FromUserName, function(err, user) {
      console.log(newmy.items[0].url);
      if (user != null) {
        return Inte.getInteAll(user._id, function(err, count) {
          return callback(newmy);
        });
      } else {
        return callback(newmy);
      }
    });
  } else {
    return callback(empty);
  }
}


/*
--------------------------------------------
     Begin wechat-qa.coffee
--------------------------------------------
 */

myProcess = [];

getQA = function(message, openid, callback) {
  var key, qa, _n;
  key = message;
  console.log("user " + openid + " :", myProcess[openid]);
  if (myProcess[openid] != null) {
    qa = myProcess[openid];
    if (qa.next != null) {
      qa = myProcess[openid].next;
      qa = searchQA(key, qa);
      if (qa != null) {
        if (qa.next != null) {
          myProcess[openid] = qa;
        }
      } else {
        callback({});
      }
    }
  } else {
    myProcess[openid] = searchQA(key, _qa);
    qa = _n = myProcess[openid];
  }
  return callback(qa);
};

searchQA = function(key, list) {
  var a, _i, _len;
  for (_i = 0, _len = list.length; _i < _len; _i++) {
    a = list[_i];
    if (a.key === key) {
      return a;
    }
  }
  return null;
};

clearQA = function(openid) {
  console.log("clear: " + openid);
  return delete myProcess[openid];
};

overQA = function(openid, backup) {
  if (backup == null) {
    backup = "test";
  }
  console.log("记录抽奖ID: ", openid);
  clearQA(openid);
  return Inser_db_qauser(openid, backup);
};

_nr = "\n";

_qa = [
  {
    name: "查看活动详情",
    key: "1",
    type: "news",
    items: [
      {
        backContent: "活动详情",
        title: "Samsung GALAXY K zoom 让每个瞬间都精彩",
        description: '参与活动赢取Samsung GALAXY K zoom，开启你的幸福之旅~',
        picurl: "https://mmbiz.qlogo.cn/mmbiz/icfeQvJeAJzNWR5PaQgtD89x9Drdb3oBEH7YOOcibiajvicowpicTgUjrlNzswycHMGPKjytQvc4icOqb3I627BnkWOQ/0",
        url: "http://mp.weixin.qq.com/s?__biz=MzA5MTUwMzMyNA==&mid=200501036&idx=1&sn=7c19d06ff08719359639336eb357bbfe&scene=1&key=540a4984c4f01b4dfee5b42dd37ecdce5d742de5ce37445e8706c97c1def9f100a8bcf3813e0ea9f10b6acf5efa0d42b&ascene=0&uin=MjY4NjM5MDU%3D"
      }
    ]
  }
];
